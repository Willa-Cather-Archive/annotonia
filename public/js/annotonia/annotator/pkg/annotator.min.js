(function(){var j,t,a,i,v,k,e,m,q,u,C,p,w,x,l,f,s,c,b,A,B,n,d,y,r=[].slice,o={}.hasOwnProperty,z=function(F,D){for(var g in D){if(o.call(D,g)){F[g]=D[g]}}function E(){this.constructor=F}E.prototype=D.prototype;F.prototype=new E();F.__super__=D.prototype;return F},h=function(g,D){return function(){return g.apply(D,arguments)}};x=function(g){var D;D=this.map(function(){var G,E,H,F;H="";G=this;while((G!=null?G.nodeType:void 0)===Node.ELEMENT_NODE&&G!==g){F=G.tagName.replace(":","\\:");E=j(G.parentNode).children(F).index(G)+1;E="["+E+"]";H="/"+G.tagName.toLowerCase()+E+H;G=G.parentNode}return H});return D.get()};l=function(E){var F,D,G,g;F=function(I){var H,J;H=C(I);J=p(I);return""+H+"["+J+"]"};g=E;D=function(I){var H;H="";while(I!==g){if(I==null){throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+g)}H=(F(I))+"/"+H;I=I.parentNode}H="/"+H;H=H.replace(/\/$/,"");return H};G=this.map(function(){var H;H=D(this);return H});return G.get()};e=function(F,I,H){var D,E,K,g,G,J;if(!F.hasChildNodes()){throw new Error("XPath error: node has no children!")}E=F.childNodes;K=0;for(G=0,J=E.length;G<J;G++){D=E[G];g=C(D);if(g===I){K+=1;if(K===H){return D}}}throw new Error("XPath error: wanted child not found.")};C=function(g){var D;D=g.nodeName.toLowerCase();switch(D){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return D}};p=function(D){var E,g;E=0;g=D;while(g){if(g.nodeName===D.nodeName){E++}g=g.previousSibling}return E};w=null;if(typeof Gettext!=="undefined"&&Gettext!==null){s=new Gettext({domain:"annotator"});w=function(g){return s.gettext(g)}}else{w=function(g){return g}}y=function(g){return w(g)};if(!(typeof jQuery!=="undefined"&&jQuery!==null?(n=jQuery.fn)!=null?n.jquery:void 0:void 0)){console.error(y("Annotator requires jQuery: have you included lib/vendor/jquery.js?"))}if(!(JSON&&JSON.parse&&JSON.stringify)){console.error(y("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?"))}j=jQuery;k={};k.flatten=function(D){var g;g=function(F){var G,I,H,E;I=[];for(H=0,E=F.length;H<E;H++){G=F[H];I=I.concat(G&&j.isArray(G)?g(G):G)}return I};return g(D)};k.contains=function(g,E){var D;D=E;while(D!=null){if(D===g){return true}D=D.parentNode}return false};k.getTextNodes=function(D){var g;g=function(F){var E;if(F&&F.nodeType!==Node.TEXT_NODE){E=[];if(F.nodeType!==Node.COMMENT_NODE){F=F.lastChild;while(F){E.push(g(F));F=F.previousSibling}}return E.reverse()}else{return F}};return D.map(function(){return k.flatten(g(this))})};k.getLastTextNodeUpTo=function(D){var g;switch(D.nodeType){case Node.TEXT_NODE:return D;case Node.ELEMENT_NODE:if(D.lastChild!=null){g=k.getLastTextNodeUpTo(D.lastChild);if(g!=null){return g}}break}D=D.previousSibling;if(D!=null){return k.getLastTextNodeUpTo(D)}else{return null}};k.getFirstTextNodeNotBefore=function(D){var g;switch(D.nodeType){case Node.TEXT_NODE:return D;case Node.ELEMENT_NODE:if(D.firstChild!=null){g=k.getFirstTextNodeNotBefore(D.firstChild);if(g!=null){return g}}break}D=D.nextSibling;if(D!=null){return k.getFirstTextNodeNotBefore(D)}else{return null}};k.readRangeViaSelection=function(g){var D;D=k.getGlobal().getSelection();D.removeAllRanges();D.addRange(g.toRange());return D.toString()};k.xpathFromNode=function(E,F){var D,g;try{g=x.call(E,F)}catch(G){D=G;console.log("jQuery-based XPath construction failed! Falling back to manual.");g=l.call(E,F)}return g};k.nodeFromXPath=function(H,J){var L,g,E,D,I,G,K,F;I=H.substring(1).split("/");E=J;for(G=0,K=I.length;G<K;G++){D=I[G];F=D.split("["),g=F[0],L=F[1];L=L!=null?parseInt((L!=null?L.split("]"):void 0)[0]):1;E=e(E,g.toLowerCase(),L)}return E};k.escape=function(g){return g.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};k.uuid=(function(){var g;g=0;return function(){return g++}})();k.getGlobal=function(){return(function(){return this})()};k.maxZIndex=function(E){var D,g;D=(function(){var H,G,F;F=[];for(H=0,G=E.length;H<G;H++){g=E[H];if(j(g).css("position")==="static"){F.push(-1)}else{F.push(parseFloat(j(g).css("z-index"))||-1)}}return F})();return Math.max.apply(Math,D)};k.mousePosition=function(D,F){var E,g;if((g=j(F).css("position"))!=="absolute"&&g!=="fixed"&&g!=="relative"){F=j(F).offsetParent()[0]}E=j(F).offset();return{top:D.pageY-E.top,left:D.pageX-E.left}};k.preventEventDefault=function(g){return g!=null?typeof g.preventDefault==="function"?g.preventDefault():void 0:void 0};q=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!=="undefined"&&console!==null){if(console.group==null){console.group=function(g){return console.log("GROUP: ",g)}}if(console.groupCollapsed==null){console.groupCollapsed=console.group}for(c=0,A=q.length;c<A;c++){m=q[c];if(console[m]==null){console[m]=function(){return console.log(y("Not implemented:")+(" console."+name))}}}}else{this.console={};for(b=0,B=q.length;b<B;b++){m=q[b];this.console[m]=function(){}}this.console.error=function(){var g;g=1<=arguments.length?r.call(arguments,0):[];return alert("ERROR: "+(g.join(", ")))};this.console.warn=function(){var g;g=1<=arguments.length?r.call(arguments,0):[];return alert("WARNING: "+(g.join(", ")))}}a=(function(){g.prototype.events={};g.prototype.options={};g.prototype.element=null;function g(E,D){this.options=j.extend(true,{},this.options,D);this.element=j(E);this._closures={};this.on=this.subscribe;this.addEvents()}g.prototype.destroy=function(){return this.removeEvents()};g.prototype.addEvents=function(){var H,G,E,D,F;D=g._parseEvents(this.events);F=[];for(G=0,E=D.length;G<E;G++){H=D[G];F.push(this._addEvent(H.selector,H.event,H.functionName))}return F};g.prototype.removeEvents=function(){var H,G,E,D,F;D=g._parseEvents(this.events);F=[];for(G=0,E=D.length;G<E;G++){H=D[G];F.push(this._removeEvent(H.selector,H.event,H.functionName))}return F};g.prototype._addEvent=function(D,E,F){var H,G=this;H=function(){return G[F].apply(G,arguments)};if(D===""&&g._isCustomEvent(E)){this.subscribe(E,H)}else{this.element.delegate(D,E,H)}this._closures[""+D+"/"+E+"/"+F]=H;return this};g.prototype._removeEvent=function(D,E,F){var G;G=this._closures[""+D+"/"+E+"/"+F];if(D===""&&g._isCustomEvent(E)){this.unsubscribe(E,G)}else{this.element.undelegate(D,E,G)}delete this._closures[""+D+"/"+E+"/"+F];return this};g.prototype.publish=function(){this.element.triggerHandler.apply(this.element,arguments);return this};g.prototype.subscribe=function(D,F){var E;E=function(){return F.apply(this,[].slice.call(arguments,1))};E.guid=F.guid=(j.guid+=1);this.element.bind(D,E);return this};g.prototype.unsubscribe=function(){this.element.unbind.apply(this.element,arguments);return this};return g})();a._parseEvents=function(E){var H,F,J,I,D,G,g;F=[];for(I in E){J=E[I];g=I.split(" "),D=2<=g.length?r.call(g,0,G=g.length-1):(G=0,[]),H=g[G++];F.push({selector:D.join(" "),event:H,functionName:J})}return F};a.natives=(function(){var D,g,E;g=(function(){var F,G;F=jQuery.event.special;G=[];for(D in F){if(!o.call(F,D)){continue}E=F[D];G.push(D)}return G})();return"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(g)})();a._isCustomEvent=function(g){g=g.split(".")[0];return j.inArray(g,a.natives)===-1};v={};v.sniff=function(g){if(g.commonAncestorContainer!=null){return new v.BrowserRange(g)}else{if(typeof g.start==="string"){return new v.SerializedRange(g)}else{if(g.start&&typeof g.start==="object"){return new v.NormalizedRange(g)}else{console.error(y("Could not sniff range type"));return false}}}};v.nodeFromXPath=function(D,g){var I,H,E,G,F;if(g==null){g=document}H=function(L,J){var K;if(J==null){J=null}try{return document.evaluate("."+L,g,J,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(M){K=M;console.log("XPath evaluation failed.");console.log("Trying fallback...");return k.nodeFromXPath(L,g)}};if(!j.isXMLDoc(document.documentElement)){return H(D)}else{I=document.createNSResolver(document.ownerDocument===null?document.documentElement:document.ownerDocument.documentElement);G=H(D,I);if(!G){D=((function(){var M,K,J,L;J=D.split("/");L=[];for(M=0,K=J.length;M<K;M++){F=J[M];if(F&&F.indexOf(":")===-1){L.push(F.replace(/^([a-z]+)/,"xhtml:$1"))}else{L.push(F)}}return L})()).join("/");E=document.lookupNamespaceURI(null);I=function(J){if(J==="xhtml"){return E}else{return document.documentElement.getAttribute("xmlns:"+J)}};G=H(D,I)}return G}};v.RangeError=(function(g){z(D,g);function D(F,G,E){this.type=F;this.message=G;this.parent=E!=null?E:null;D.__super__.constructor.call(this,this.message)}return D})(Error);v.BrowserRange=(function(){function g(D){this.commonAncestorContainer=D.commonAncestorContainer;this.startContainer=D.startContainer;this.startOffset=D.startOffset;this.endContainer=D.endContainer;this.endOffset=D.endOffset}g.prototype.normalize=function(D){var H,G,F,E;if(this.tainted){console.error(y("You may only call normalize() once on a BrowserRange!"));return false}else{this.tainted=true}E={};if(this.startContainer.nodeType===Node.ELEMENT_NODE){E.start=k.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]);E.startOffset=0}else{E.start=this.startContainer;E.startOffset=this.startOffset}if(this.endContainer.nodeType===Node.ELEMENT_NODE){G=this.endContainer.childNodes[this.endOffset];if(G!=null){H=G;while((H!=null)&&(H.nodeType!==Node.TEXT_NODE)){H=H.firstChild}if(H!=null){E.end=H;E.endOffset=0}}if(E.end==null){G=this.endContainer.childNodes[this.endOffset-1];E.end=k.getLastTextNodeUpTo(G);E.endOffset=E.end.nodeValue.length}}else{E.end=this.endContainer;E.endOffset=this.endOffset}F={};if(E.startOffset>0){if(E.start.nodeValue.length>E.startOffset){F.start=E.start.splitText(E.startOffset)}else{F.start=E.start.nextSibling}}else{F.start=E.start}if(E.start===E.end){if(F.start.nodeValue.length>(E.endOffset-E.startOffset)){F.start.splitText(E.endOffset-E.startOffset)}F.end=F.start}else{if(E.end.nodeValue.length>E.endOffset){E.end.splitText(E.endOffset)}F.end=E.end}F.commonAncestor=this.commonAncestorContainer;while(F.commonAncestor.nodeType!==Node.ELEMENT_NODE){F.commonAncestor=F.commonAncestor.parentNode}return new v.NormalizedRange(F)};g.prototype.serialize=function(D,E){return this.normalize(D).serialize(D,E)};return g})();v.NormalizedRange=(function(){function g(D){this.commonAncestor=D.commonAncestor;this.start=D.start;this.end=D.end}g.prototype.normalize=function(D){return this};g.prototype.limit=function(J){var F,I,G,H,E,D;F=j.grep(this.textNodes(),function(K){return K.parentNode===J||j.contains(J,K.parentNode)});if(!F.length){return null}this.start=F[0];this.end=F[F.length-1];G=j(this.start).parents();D=j(this.end).parents();for(H=0,E=D.length;H<E;H++){I=D[H];if(G.index(I)!==-1){this.commonAncestor=I;break}}return this};g.prototype.serialize=function(F,G){var E,D,H;D=function(M,L){var K,J,O,R,Q,P,N,I;if(G){R=j(M).parents(":not("+G+")").eq(0)}else{R=j(M).parent()}P=k.xpathFromNode(R,F)[0];Q=k.getTextNodes(R);J=Q.slice(0,Q.index(M));O=0;for(N=0,I=J.length;N<I;N++){K=J[N];O+=K.nodeValue.length}if(L){return[P,O+M.nodeValue.length]}else{return[P,O]}};H=D(this.start);E=D(this.end,true);return new v.SerializedRange({start:H[0],end:E[0],startOffset:H[1],endOffset:E[1]})};g.prototype.text=function(){var D;return((function(){var H,F,E,G;E=this.textNodes();G=[];for(H=0,F=E.length;H<F;H++){D=E[H];G.push(D.nodeValue)}return G}).call(this)).join("")};g.prototype.textNodes=function(){var E,G,F,D;F=k.getTextNodes(j(this.commonAncestor));D=[F.index(this.start),F.index(this.end)],G=D[0],E=D[1];return j.makeArray(F.slice(G,+E+1||9000000000))};g.prototype.toRange=function(){var D;D=document.createRange();D.setStartBefore(this.start);D.setEndAfter(this.end);return D};return g})();v.SerializedRange=(function(){function g(D){this.start=D.start;this.startOffset=D.startOffset;this.end=D.end;this.endOffset=D.endOffset}g.prototype.normalize=function(P){var L,O,G,I,F,N,S,R,K,H,E,D,M,J;N={};M=["start","end"];for(K=0,E=M.length;K<E;K++){F=M[K];try{I=v.nodeFromXPath(this[F],P)}catch(Q){O=Q;throw new v.RangeError(F,("Error while finding "+F+" node: "+this[F]+": ")+O,O)}if(!I){throw new v.RangeError(F,"Couldn't find "+F+" node: "+this[F])}G=0;S=this[F+"Offset"];if(F==="end"){S--}J=k.getTextNodes(j(I));for(H=0,D=J.length;H<D;H++){R=J[H];if(G+R.nodeValue.length>S){N[F+"Container"]=R;N[F+"Offset"]=this[F+"Offset"]-G;break}else{G+=R.nodeValue.length}}if(N[F+"Offset"]==null){throw new v.RangeError(""+F+"offset","Couldn't find offset "+this[F+"Offset"]+" in element "+this[F])}}L=document.compareDocumentPosition==null?function(U,T){return U.contains(T)}:function(U,T){return U.compareDocumentPosition(T)&16};j(N.startContainer).parents().each(function(){if(L(this,N.endContainer)){N.commonAncestorContainer=this;return false}});return new v.BrowserRange(N).normalize(P)};g.prototype.serialize=function(D,E){return this.normalize(D).serialize(D,E)};g.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return g})();f=this.Annotator;t=(function(g){z(D,g);D.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"};D.prototype.html={adder:'<div class="annotator-adder"><button>'+y("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'};D.prototype.options={readOnly:false};D.prototype.plugins={};D.prototype.editor=null;D.prototype.viewer=null;D.prototype.selectedRanges=null;D.prototype.mouseIsDown=false;D.prototype.ignoreMouseup=false;D.prototype.viewerHideTimer=null;function D(F,E){this.onDeleteAnnotation=h(this.onDeleteAnnotation,this);this.onEditAnnotation=h(this.onEditAnnotation,this);this.onAdderClick=h(this.onAdderClick,this);this.onAdderMousedown=h(this.onAdderMousedown,this);this.onHighlightMouseover=h(this.onHighlightMouseover,this);this.checkForEndSelection=h(this.checkForEndSelection,this);this.checkForStartSelection=h(this.checkForStartSelection,this);this.clearViewerHideTimer=h(this.clearViewerHideTimer,this);this.startViewerHideTimer=h(this.startViewerHideTimer,this);this.showViewer=h(this.showViewer,this);this.onEditorSubmit=h(this.onEditorSubmit,this);this.onEditorHide=h(this.onEditorHide,this);this.showEditor=h(this.showEditor,this);D.__super__.constructor.apply(this,arguments);this.plugins={};if(!D.supported()){return this}if(!this.options.readOnly){this._setupDocumentEvents()}this._setupWrapper()._setupViewer()._setupEditor();this._setupDynamicStyle();this.adder=j(this.html.adder).appendTo(this.wrapper).hide();D._instances.push(this)}D.prototype._setupWrapper=function(){this.wrapper=j(this.html.wrapper);this.element.find("script").remove();this.element.wrapInner(this.wrapper);this.wrapper=this.element.find(".annotator-wrapper");return this};D.prototype._setupViewer=function(){var E=this;this.viewer=new D.Viewer({readOnly:this.options.readOnly});this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(G,F){if(F.text){j(G).html(k.escape(F.text))}else{j(G).html("<i>"+(y("No Comment"))+"</i>")}return E.publish("annotationViewerTextField",[G,F])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer});return this};D.prototype._setupEditor=function(){this.editor=new D.Editor();this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:y("Comments")+"\u2026",load:function(F,E){return j(F).find("textarea").val(E.text||"")},submit:function(F,E){return E.text=j(F).find("textarea").val()}});this.editor.element.appendTo(this.wrapper);return this};D.prototype._setupDocumentEvents=function(){j(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});return this};D.prototype._setupDynamicStyle=function(){var F,H,G,E;G=j("#annotator-dynamic-style");if(!G.length){G=j('<style id="annotator-dynamic-style"></style>').appendTo(document.head)}H="*"+((function(){var L,J,I,K;I=["adder","outer","notice","filter"];K=[];for(L=0,J=I.length;L<J;L++){E=I[L];K.push(":not(.annotator-"+E+")")}return K})()).join("");F=k.maxZIndex(j(document.body).find(H));F=Math.max(F,1000);G.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(F+20)+";","}",".annotator-filter {","  z-index: "+(F+10)+";","}"].join("\n"));return this};D.prototype.destroy=function(){var F,G,I,H,E;D.__super__.destroy.apply(this,arguments);j(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});j("#annotator-dynamic-style").remove();this.adder.remove();this.viewer.destroy();this.editor.destroy();this.wrapper.find(".annotator-hl").each(function(){j(this).contents().insertBefore(this);return j(this).remove()});this.wrapper.contents().insertBefore(this.wrapper);this.wrapper.remove();this.element.data("annotator",null);E=this.plugins;for(G in E){I=E[G];if(typeof(H=this.plugins[G]).destroy==="function"){H.destroy()}}F=D._instances.indexOf(this);if(F!==-1){return D._instances.splice(F,1)}};D.prototype.getSelectedRanges=function(){var H,K,I,E,G,L,M,J,F;M=k.getGlobal().getSelection();G=[];L=[];if(!M.isCollapsed){G=(function(){var P,N,O;O=[];for(K=P=0,N=M.rangeCount;0<=N?P<N:P>N;K=0<=N?++P:--P){E=M.getRangeAt(K);H=new v.BrowserRange(E);I=H.normalize().limit(this.wrapper[0]);if(I===null){L.push(E)}O.push(I)}return O}).call(this);M.removeAllRanges()}for(J=0,F=L.length;J<F;J++){E=L[J];M.addRange(E)}return j.grep(G,function(N){if(N){M.addRange(N.toRange())}return N})};D.prototype.createAnnotation=function(){var E;E={};this.publish("beforeAnnotationCreated",[E]);return E};D.prototype.setupAnnotation=function(J){var N,M,L,F,O,I,H,G,E,K;O=this.wrapper[0];J.ranges||(J.ranges=this.selectedRanges);L=[];K=J.ranges;for(I=0,G=K.length;I<G;I++){F=K[I];try{L.push(v.sniff(F).normalize(O))}catch(P){N=P;if(N instanceof v.RangeError){this.publish("rangeNormalizeFail",[J,F,N])}else{throw N}}}J.quote=[];J.ranges=[];J.highlights=[];for(H=0,E=L.length;H<E;H++){M=L[H];J.quote.push(j.trim(M.text()));J.ranges.push(M.serialize(this.wrapper[0],".annotator-hl"));j.merge(J.highlights,this.highlightRange(M))}J.quote=J.quote.join(" / ");j(J.highlights).data("annotation",J);j(J.highlights).attr("data-annotation-id",J.id);return J};D.prototype.updateAnnotation=function(E){this.publish("beforeAnnotationUpdated",[E]);j(E.highlights).attr("data-annotation-id",E.id);this.publish("annotationUpdated",[E]);return E};D.prototype.deleteAnnotation=function(G){var J,I,H,F,E;if(G.highlights!=null){E=G.highlights;for(H=0,F=E.length;H<F;H++){I=E[H];if(!(I.parentNode!=null)){continue}J=I.childNodes[0];j(I).replaceWith(I.childNodes)}}this.publish("annotationDeleted",[G]);return G};D.prototype.loadAnnotations=function(F){var H,E,G=this;if(F==null){F=[]}E=function(L){var M,J,K,I;if(L==null){L=[]}J=L.splice(0,10);for(K=0,I=J.length;K<I;K++){M=J[K];G.setupAnnotation(M)}if(L.length>0){return setTimeout((function(){return E(L)}),10)}else{return G.publish("annotationsLoaded",[H])}};H=F.slice();E(F);return this};D.prototype.dumpAnnotations=function(){if(this.plugins.Store){return this.plugins.Store.dumpAnnotations()}else{console.warn(y("Can't dump annotations without Store plugin."));return false}};D.prototype.highlightRange=function(H,M){var F,G,L,I,E,K,J;if(M==null){M="annotator-hl"}L=/^\s*$/;F=j("<span class='"+M+"'></span>");K=H.textNodes();J=[];for(I=0,E=K.length;I<E;I++){G=K[I];if(!L.test(G.nodeValue)){J.push(j(G).wrapAll(F).parent().show()[0])}}return J};D.prototype.highlightRanges=function(I,F){var J,H,G,E;if(F==null){F="annotator-hl"}J=[];for(G=0,E=I.length;G<E;G++){H=I[G];j.merge(J,this.highlightRange(H,F))}return J};D.prototype.addPlugin=function(G,F){var E,H;if(this.plugins[G]){console.error(y("You cannot have more than one instance of any plugin."))}else{E=D.Plugin[G];if(typeof E==="function"){this.plugins[G]=new E(this.element[0],F);this.plugins[G].annotator=this;if(typeof(H=this.plugins[G]).pluginInit==="function"){H.pluginInit()}}else{console.error(y("Could not load ")+G+y(" plugin. Have you included the appropriate <script> tag?"))}}return this};D.prototype.showEditor=function(E,F){this.editor.element.css(F);this.editor.load(E);this.publish("annotationEditorShown",[this.editor,E]);return this};D.prototype.onEditorHide=function(){this.publish("annotationEditorHidden",[this.editor]);return this.ignoreMouseup=false};D.prototype.onEditorSubmit=function(E){return this.publish("annotationEditorSubmit",[this.editor,E])};D.prototype.showViewer=function(F,E){this.viewer.element.css(E);this.viewer.load(F);return this.publish("annotationViewerShown",[this.viewer,F])};D.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer){return this.viewerHideTimer=setTimeout(this.viewer.hide,250)}};D.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=false};D.prototype.checkForStartSelection=function(E){if(!(E&&this.isAnnotator(E.target))){this.startViewerHideTimer()}return this.mouseIsDown=true};D.prototype.checkForEndSelection=function(J){var G,H,I,F,E;this.mouseIsDown=false;if(this.ignoreMouseup){return}this.selectedRanges=this.getSelectedRanges();E=this.selectedRanges;for(I=0,F=E.length;I<F;I++){H=E[I];G=H.commonAncestor;if(this.isAnnotator(G)){return}}if(J&&this.selectedRanges.length){return this.adder.css(k.mousePosition(J,this.wrapper[0])).show()}else{return this.adder.hide()}};D.prototype.isAnnotator=function(E){return !!j(E).parents().addBack().filter("[class^=annotator-]").not("[class=annotator-hl]").not(this.wrapper).length};D.prototype.onHighlightMouseover=function(E){var F;this.clearViewerHideTimer();if(this.mouseIsDown){return false}if(this.viewer.isShown()){this.viewer.hide()}F=j(E.target).parents(".annotator-hl").addBack().map(function(){return j(this).data("annotation")}).toArray();return this.showViewer(F,k.mousePosition(E,this.wrapper[0]))};D.prototype.onAdderMousedown=function(E){if(E!=null){E.preventDefault()}return this.ignoreMouseup=true};D.prototype.onAdderClick=function(J){var F,I,G,E,H,K=this;if(J!=null){J.preventDefault()}E=this.adder.position();this.adder.hide();F=this.setupAnnotation(this.createAnnotation());j(F.highlights).addClass("annotator-hl-temporary");H=function(){G();j(F.highlights).removeClass("annotator-hl-temporary");return K.publish("annotationCreated",[F])};I=function(){G();return K.deleteAnnotation(F)};G=function(){K.unsubscribe("annotationEditorHidden",I);return K.unsubscribe("annotationEditorSubmit",H)};this.subscribe("annotationEditorHidden",I);this.subscribe("annotationEditorSubmit",H);return this.showEditor(F,E)};D.prototype.onEditAnnotation=function(E){var F,G,I,H=this;G=this.viewer.element.position();I=function(){F();return H.updateAnnotation(E)};F=function(){H.unsubscribe("annotationEditorHidden",F);return H.unsubscribe("annotationEditorSubmit",I)};this.subscribe("annotationEditorHidden",F);this.subscribe("annotationEditorSubmit",I);this.viewer.hide();return this.showEditor(E,G)};D.prototype.onDeleteAnnotation=function(E){this.viewer.hide();return this.deleteAnnotation(E)};return D})(a);t.Plugin=(function(D){z(g,D);function g(F,E){g.__super__.constructor.apply(this,arguments)}g.prototype.pluginInit=function(){};return g})(a);u=k.getGlobal();if(((d=u.document)!=null?d.evaluate:void 0)==null){j.getScript("http://assets.annotateit.org/vendor/xpath.min.js")}if(u.getSelection==null){j.getScript("http://assets.annotateit.org/vendor/ierange.min.js")}if(u.JSON==null){j.getScript("http://assets.annotateit.org/vendor/json2.min.js")}if(u.Node==null){u.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}}t.$=j;t.Delegator=a;t.Range=v;t.Util=k;t._instances=[];t._t=y;t.supported=function(){return(function(){return !!this.getSelection})()};t.noConflict=function(){k.getGlobal().Annotator=f;return this};j.fn.annotator=function(D){var g;g=Array.prototype.slice.call(arguments,1);return this.each(function(){var E;E=j.data(this,"annotator");if(D==="destroy"){j.removeData(this,"annotator");return E!=null?E.destroy(g):void 0}else{if(E){return D&&E[D].apply(E,g)}else{E=new t(this,D);return j.data(this,"annotator",E)}}})};this.Annotator=t;t.Widget=(function(D){z(g,D);g.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}};function g(F,E){g.__super__.constructor.apply(this,arguments);this.classes=j.extend({},t.Widget.prototype.classes,this.classes)}g.prototype.destroy=function(){this.removeEvents();return this.element.remove()};g.prototype.checkOrientation=function(){var H,I,E,G,F;this.resetOrientation();F=j(t.Util.getGlobal());G=this.element.children(":first");I=G.offset();E={top:F.scrollTop(),right:F.width()+F.scrollLeft()};H={top:I.top,right:I.left+G.width()};if((H.top-E.top)<0){this.invertY()}if((H.right-E.right)>0){this.invertX()}return this};g.prototype.resetOrientation=function(){this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);return this};g.prototype.invertX=function(){this.element.addClass(this.classes.invert.x);return this};g.prototype.invertY=function(){this.element.addClass(this.classes.invert.y);return this};g.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)};g.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)};return g})(a);t.Editor=(function(D){z(g,D);g.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"};g.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"};g.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+y("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+y("Save")+"</a>\n    </div>\n  </form>\n</div>";g.prototype.options={};function g(E){this.onCancelButtonMouseover=h(this.onCancelButtonMouseover,this);this.processKeypress=h(this.processKeypress,this);this.submit=h(this.submit,this);this.load=h(this.load,this);this.hide=h(this.hide,this);this.show=h(this.show,this);g.__super__.constructor.call(this,j(this.html)[0],E);this.fields=[];this.annotation={}}g.prototype.show=function(E){t.Util.preventEventDefault(E);this.element.removeClass(this.classes.hide);this.element.find(".annotator-save").addClass(this.classes.focus);this.checkOrientation();this.element.find(":input:first").focus();this.setupDraggables();return this.publish("show")};g.prototype.hide=function(E){t.Util.preventEventDefault(E);this.element.addClass(this.classes.hide);return this.publish("hide")};g.prototype.load=function(F){var H,G,E,I;this.annotation=F;this.publish("load",[this.annotation]);I=this.fields;for(G=0,E=I.length;G<E;G++){H=I[G];H.load(H.element,this.annotation)}return this.show()};g.prototype.submit=function(G){var H,F,E,I;t.Util.preventEventDefault(G);I=this.fields;for(F=0,E=I.length;F<E;F++){H=I[F];H.submit(H.element,this.annotation)}this.publish("save",[this.annotation]);return this.hide()};g.prototype.addField=function(F){var G,H,E;H=j.extend({id:"annotator-field-"+t.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},F);E=null;G=j('<li class="annotator-item" />');H.element=G[0];switch(H.type){case"textarea":E=j("<textarea />");break;case"input":case"checkbox":E=j("<input />");break;case"select":E=j("<select />")}G.append(E);E.attr({id:H.id,placeholder:H.label});if(H.type==="checkbox"){E[0].type="checkbox";G.addClass("annotator-checkbox");G.append(j("<label />",{"for":H.id,html:H.label}))}this.element.find("ul:first").append(G);this.fields.push(H);return H.element};g.prototype.checkOrientation=function(){var E,F;g.__super__.checkOrientation.apply(this,arguments);F=this.element.find("ul");E=this.element.find(".annotator-controls");if(this.element.hasClass(this.classes.invert.y)){E.insertBefore(F)}else{if(E.is(":first-child")){E.insertAfter(F)}}return this};g.prototype.processKeypress=function(E){if(E.keyCode===27){return this.hide()}else{if(E.keyCode===13&&!E.shiftKey){return this.submit()}}};g.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)};g.prototype.setupDraggables=function(){var H,P,G,L,E,J,N,I,F,M,O,K=this;this.element.find(".annotator-resize").remove();if(this.element.hasClass(this.classes.invert.y)){G=this.element.find(".annotator-item:last")}else{G=this.element.find(".annotator-item:first")}if(G){j('<span class="annotator-resize"></span>').appendTo(G)}E=null;H=this.classes;L=this.element;M=null;F=L.find(".annotator-resize");P=L.find(".annotator-controls");O=false;J=function(Q){if(Q.target===this){E={element:this,top:Q.pageY,left:Q.pageX};M=L.find("textarea:first");j(window).bind({"mouseup.annotator-editor-resize":I,"mousemove.annotator-editor-resize":N});return Q.preventDefault()}};I=function(){E=null;return j(window).unbind(".annotator-editor-resize")};N=function(U){var V,S,R,Q,T;if(E&&O===false){V={top:U.pageY-E.top,left:U.pageX-E.left};if(E.element===F[0]){Q=M.outerHeight();T=M.outerWidth();S=L.hasClass(H.invert.x)?-1:1;R=L.hasClass(H.invert.y)?1:-1;M.height(Q+(V.top*R));M.width(T+(V.left*S));if(M.outerHeight()!==Q){E.top=U.pageY}if(M.outerWidth()!==T){E.left=U.pageX}}else{if(E.element===P[0]){L.css({top:parseInt(L.css("top"),10)+V.top,left:parseInt(L.css("left"),10)+V.left});E.top=U.pageY;E.left=U.pageX}}O=true;return setTimeout(function(){return O=false},1000/60)}};F.bind("mousedown",J);return P.bind("mousedown",J)};return g})(t.Widget);t.Viewer=(function(g){z(D,g);D.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"};D.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"};D.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'};D.prototype.options={readOnly:false};function D(E){this.onDeleteClick=h(this.onDeleteClick,this);this.onEditClick=h(this.onEditClick,this);this.load=h(this.load,this);this.hide=h(this.hide,this);this.show=h(this.show,this);D.__super__.constructor.call(this,j(this.html.element)[0],E);this.item=j(this.html.item)[0];this.fields=[];this.annotations=[]}D.prototype.show=function(F){var E,G=this;t.Util.preventEventDefault(F);E=this.element.find(".annotator-controls").addClass(this.classes.showControls);setTimeout((function(){return E.removeClass(G.classes.showControls)}),500);this.element.removeClass(this.classes.hide);return this.checkOrientation().publish("show")};D.prototype.isShown=function(){return !this.element.hasClass(this.classes.hide)};D.prototype.hide=function(E){t.Util.preventEventDefault(E);this.element.addClass(this.classes.hide);return this.publish("hide")};D.prototype.load=function(E){var M,Q,P,O,R,K,H,T,N,J,S,G,F,V,U,L,I;this.annotations=E||[];S=this.element.find("ul:first").empty();L=this.annotations;for(G=0,V=L.length;G<V;G++){M=L[G];T=j(this.item).clone().appendTo(S).data("annotation",M);if(M.anno_ref_id!==undefined&&M.anno_ref_id!==""){if(t.anno_ref_data==undefined||t.anno_ref_data[M.anno_ref_id]==undefined||t.anno_ref_new){if(t.Plugin.Store&&!t.Plugin.Offline.Store.localStorage.length){t.is_offline=false;if(t.anno_ref_data==undefined){t.anno_ref_data={}}if(t.anno_ref_data[M.anno_ref_id]==undefined){j.ajax("https://rosie.unl.edu/annostore/search?_id="+M.anno_ref_id,{async:false}).done(function(W){if(W.rows[0]!==undefined){t.anno_ref_data[W.rows[0].id]=W.rows[0];t.anno_ref_data.invalid_ref=false;t.anno_ref_data.ref_data_fail=false}else{t.anno_ref_data={invalid_ref:true}}}).fail(function(){t.anno_ref_data={ref_data_fail:true}})}}else{if(t.Plugin.Offline){t.is_offline=true;if(t.anno_ref_data==undefined){t.anno_ref_data={}}if(t.anno_ref_data[M.anno_ref_id]==undefined){t.anno_ref_data[M.anno_ref_id]=JSON.parse(t.Plugin.Offline.Store.localStorage[t.Plugin.Offline.Store.KEY_PREFIX+t.Plugin.Offline.ANNOTATION_PREFIX+M.anno_ref_id])}}}if(!(t.anno_ref_data.invalid_ref||t.anno_ref_data.ref_data_fail)){if(!t.is_offline){t.anno_ref_data[M.anno_ref_id].text+='<br><p><a href="https://rosie.unl.edu/annotonia_status/edit.php?id='+M.id+'"><strong>&gt;&gt; Edit Referenced Annotation</strong></a></p>'}t.anno_ref_new=false}else{if(t.anno_ref_data.invalid_ref){t.anno_ref_data[M.anno_ref_id]={};t.anno_ref_data[M.anno_ref_id].text="<p>Sorry, that ID doesn't appear to point to an existing annotation.</p>"}else{if(t.anno_ref_data.ref_data_fail){t.anno_ref_data[M.anno_ref_id]={};t.anno_ref_data[M.anno_ref_id].text="<p>Sorry, there was a problem retrieving the referenced annotation. Mouse away and we'll try again.</p>"}}}if(!t.is_offline){t.anno_ref_data[M.anno_ref_id].viewerReadOnly=true}}if(!M.text){M.text="<strong>Annotation Reference</strong><p>ID: "+M.anno_ref_id+"</p>"}L.push(t.anno_ref_data[M.anno_ref_id]);V++;if(t.anno_ref_data.ref_data_fail){t.anno_ref_data[M.anno_ref_id]=undefined}}P=T.find(".annotator-controls");N=P.find(".annotator-link");R=P.find(".annotator-edit");O=P.find(".annotator-delete");J=new i(M.links||[]).get("alternate",{type:"text/html"});if(J.length===0||(J[0].href==null)){N.remove()}else{N.attr("href",J[0].href)}if(this.options.readOnly||M.viewerReadOnly){R.remove();O.remove()}else{Q={showEdit:function(){return R.removeAttr("disabled")},hideEdit:function(){return R.attr("disabled","disabled")},showDelete:function(){return O.removeAttr("disabled")},hideDelete:function(){return O.attr("disabled","disabled")}}}I=this.fields;for(F=0,U=I.length;F<U;F++){H=I[F];K=j(H.element).clone().appendTo(T)[0];H.load(K,M,Q)}}this.publish("load",[this.annotations]);return this.show()};D.prototype.addField=function(E){var F;F=j.extend({load:function(){}},E);F.element=j("<div />")[0];this.fields.push(F);F.element;return this};D.prototype.onEditClick=function(E){return this.onButtonClick(E,"edit")};D.prototype.onDeleteClick=function(E){return this.onButtonClick(E,"delete")};D.prototype.onButtonClick=function(G,E){var F;F=j(G.target).parents(".annotator-annotation");var H=true;if(E==="delete"){H=false;H=window.confirm("Are you sure you want to delete this annotation?")}if(H){return this.publish(E,[F.data("annotation")])}};return D})(t.Widget);i=(function(){function g(D){this.data=D}g.prototype.get=function(N,K){var J,H,M,I,L,F,D,E,G;if(K==null){K={}}K=j.extend({},K,{rel:N});M=(function(){var O;O=[];for(H in K){if(!o.call(K,H)){continue}L=K[H];O.push(H)}return O})();E=this.data;G=[];for(F=0,D=E.length;F<D;F++){J=E[F];I=M.reduce((function(O,P){return O&&(J[P]===K[P])}),true);if(I){G.push(J)}else{continue}}return G};return g})();t=t||{};t.Notification=(function(g){z(D,g);D.prototype.events={click:"hide"};D.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}};function D(E){this.hide=h(this.hide,this);this.show=h(this.show,this);D.__super__.constructor.call(this,j(this.options.html).appendTo(document.body)[0],E)}D.prototype.show=function(F,E){if(E==null){E=t.Notification.INFO}this.currentStatus=E;j(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(k.escape(F||""));setTimeout(this.hide,5000);return this};D.prototype.hide=function(){if(this.currentStatus==null){this.currentStatus=t.Notification.INFO}j(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]);return this};return D})(a);t.Notification.INFO="info";t.Notification.SUCCESS="success";t.Notification.ERROR="error";j(function(){var g;g=new t.Notification;t.showNotification=g.show;return t.hideNotification=g.hide})}).call(this);